# HeyyyyDate Image Delivery Worker

Cloudflare Worker for secure image delivery with JWT-based access control and automatic blur enforcement for locked character images.

## Overview

This worker serves character images from Cloudflare R2 storage with the following features:

- **JWT Token Authentication** - Validates image access tokens generated by backend
- **Blur Enforcement** - Automatically applies blur to locked images based on relationship level
- **Image Transforms** - On-the-fly resizing and quality adjustment via Cloudflare Image Resizing
- **Caching** - Aggressive caching with 1-year TTL for optimal performance
- **Security** - Prevents token reuse across different characters

## Architecture

```
Frontend                    Backend                     CF Worker                 R2
   │                           │                            │                      │
   │ GET /gallery              │                            │                      │
   │ ───────────────────────►  │                            │                      │
   │                           │                            │                      │
   │ ◄─── images[] + token ─── │  (JWT with unlocked_types) │                      │
   │                           │                            │                      │
   │ GET /img/alex/casual_1.png?token=xxx                   │                      │
   │ ─────────────────────────────────────────────────────► │                      │
   │                           │                            │ verify JWT           │
   │                           │                            │ check unlocked_types │
   │                           │                            │ ────────────────────►│
   │                           │                            │ ◄─── image bytes ─── │
   │                           │                            │ apply blur if locked │
   │ ◄───────────────────────────────── image (blurred?) ── │                      │
```

### JWT Token Structure

Tokens are generated by the backend (`ImageTokenService`) and contain:

```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "character_card": "alex_intellectual",
  "unlocked_types": ["profile", "casual"],
  "relationship_level": 4,
  "exp": 1735689600,
  "iat": 1735603200
}
```

### Image Key Format

R2 object keys follow this pattern:
```
{character_card}/{image_type}_{variant}.{extension}

Examples:
  alex_intellectual/profile_1.png
  luna_dancer/casual_2.jpg
  preview/alex_intellectual/profile_1.png  (staging/dev)
```

### URL Format

```
/{character_card}/{image_type}_{variant}.{ext}?token=JWT&w=WIDTH&h=HEIGHT&q=QUALITY

Parameters:
  - token (required): JWT token from backend
  - w (optional): Width in pixels for resize
  - h (optional): Height in pixels for resize
  - q (optional): Quality 1-100 for compression

Examples:
  /alex_intellectual/profile_1.png?token=eyJhbG...
  /luna_dancer/casual_2.jpg?token=eyJhbG...&w=800&q=85
```

### Blur Logic

```typescript
// Extract image type from key (e.g., "casual" from "alex_intellectual/casual_1.png")
const imageType = extractImageType(imageKey);

// Check if this image type is unlocked for this user
const isUnlocked = claims.unlocked_types.includes(imageType);

if (!isUnlocked) {
  // Apply blur=50 via Cloudflare Image Resizing
  transformOptions.image.blur = 50;
}
```

## Prerequisites

### 1. Cloudflare Account

- Sign up at [cloudflare.com](https://cloudflare.com)
- Free tier works, but **Paid Workers plan ($5/month) required** for Image Resizing

### 2. Wrangler CLI

```bash
# Install globally
npm install -g wrangler

# Or use npx (no install needed)
npx wrangler --version
```

### 3. Authentication

```bash
# Login to Cloudflare
wrangler login

# Verify authentication
wrangler whoami
```

### 4. R2 Bucket

You need an R2 bucket created first:

```bash
# List existing buckets
wrangler r2 bucket list

# Create bucket if it doesn't exist
wrangler r2 bucket create character-images

# Verify creation
wrangler r2 bucket list | grep character-images
```

## Setup

### 1. Install Dependencies

```bash
cd workers/image-delivery
npm install
```

### 2. Configure Secrets

The worker requires one secret: `IMAGE_TOKEN_SECRET`

**IMPORTANT:** This **must match** the `IMAGE_TOKEN_SECRET` in your backend `.env` file.

```bash
# Set secret for staging
wrangler secret put IMAGE_TOKEN_SECRET --env staging
# Paste the secret value when prompted (same as backend)

# Set secret for production
wrangler secret put IMAGE_TOKEN_SECRET --env production
# Paste the secret value when prompted (same as backend)
```

### 3. Verify Configuration

Check `wrangler.toml`:

```toml
name = "heyyyydate-image-delivery"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[[r2_buckets]]
binding = "IMAGES_BUCKET"
bucket_name = "character-images"  # ← Verify this matches your bucket

[env.staging]
name = "heyyyydate-image-delivery-staging"
# ...

[env.production]
name = "heyyyydate-image-delivery"
# ...
```

## Deployment

### Development / Local Testing

```bash
npm run dev

# Worker runs on http://localhost:8787
# Test health check:
curl http://localhost:8787/health
```

### Deploy to Staging

```bash
npm run deploy:staging

# Output:
# ✨ Deployment complete!
# ✨ https://heyyyydate-image-delivery-staging.<account>.workers.dev
```

**After deployment:**
1. Copy the worker URL
2. Update backend `.env`:
   ```bash
   IMAGE_WORKER_URL=https://heyyyydate-image-delivery-staging.<account>.workers.dev
   ```
3. Restart backend to pick up new config

### Deploy to Production

```bash
npm run deploy:production

# Output:
# ✨ Deployment complete!
# ✨ https://heyyyydate-image-delivery.<account>.workers.dev
```

### Custom Domain (Optional)

For production, you can route the worker to a custom domain:

1. Add domain to Cloudflare
2. Uncomment in `wrangler.toml`:
   ```toml
   routes = [
     { pattern = "images.heyyyydate.com/*", zone_name = "heyyyydate.com" }
   ]
   ```
3. Redeploy: `npm run deploy:production`
4. Update backend `IMAGE_WORKER_URL=https://images.heyyyydate.com`

## Testing

### 1. Health Check

```bash
curl https://heyyyydate-image-delivery-staging.<account>.workers.dev/health

# Expected: {"status":"ok"}
```

### 2. Test with Real Token

First, generate an image and get a token from the backend:

```bash
# Get gallery (returns images with tokens)
curl http://localhost:8000/api/images/characters/{character_id}/gallery \
  -H "Authorization: Bearer {your_jwt_token}"

# Response includes image_token for each image:
{
  "character_id": "...",
  "images": [...],
  "image_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

Then test the worker:

```bash
# Test unlocked image (should return original)
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/profile_1.png?token={image_token}" \
  --output test_unlocked.png

# Test locked image (should have blur applied)
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/intimate_1.png?token={image_token}" \
  --output test_locked.png

# Check headers
curl -I "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/intimate_1.png?token={image_token}"

# Should include:
# X-Image-Blurred: true (if image is locked)
```

### 3. Test Invalid Token

```bash
# Missing token
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/profile_1.png"
# Expected: 401 Unauthorized: Missing token

# Invalid token
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/profile_1.png?token=invalid"
# Expected: 401 Unauthorized: Invalid or expired token

# Token for different character
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/other_character/profile_1.png?token={alex_token}"
# Expected: 403 Forbidden: Token not valid for this character
```

## End-to-End Testing

Complete workflow from image generation to delivery:

```bash
# 1. Generate base options (admin endpoint)
curl -X POST http://localhost:8000/api/images/admin/characters/{character_id}/generate-base-options \
  -H "Content-Type: application/json" \
  -H "X-Admin-API-Key: {your_admin_key}" \
  -d '{"count": 2, "use_preview": true}'

# Response includes R2 keys:
{
  "character_id": "...",
  "character_card": "alex_intellectual",
  "keys": [
    "preview/alex_intellectual/profile_1.png",
    "preview/alex_intellectual/profile_2.png"
  ]
}

# 2. Select base image (admin endpoint)
curl -X POST http://localhost:8000/api/images/admin/characters/{character_id}/select-base-image \
  -H "Content-Type: application/json" \
  -H "X-Admin-API-Key: {your_admin_key}" \
  -d '{"preview_key": "preview/alex_intellectual/profile_1.png"}'

# 3. Generate variants (admin endpoint)
curl -X POST http://localhost:8000/api/images/admin/characters/{character_id}/generate-variant \
  -H "Content-Type: application/json" \
  -H "X-Admin-API-Key: {your_admin_key}" \
  -d '{"image_type": "casual"}'

# 4. Get gallery (user endpoint - returns tokens)
curl http://localhost:8000/api/images/characters/{character_id}/gallery \
  -H "Authorization: Bearer {user_jwt}"

# 5. Access image via worker
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/casual_1.png?token={image_token}" \
  --output casual.png
```

## Monitoring

### View Logs

```bash
# Tail logs for staging
wrangler tail --env staging

# Tail logs for production
wrangler tail --env production
```

### Check Analytics

Visit [Cloudflare Dashboard](https://dash.cloudflare.com/) → Workers & Pages → heyyyydate-image-delivery

Metrics include:
- Requests per second
- Errors
- CPU time
- Request status codes

### Common Issues

#### "Error 1101: Worker threw exception"

**Cause:** Runtime error in worker code

**Debug:**
```bash
# Check logs
wrangler tail --env staging

# Common issues:
# - IMAGE_TOKEN_SECRET not set or wrong
# - R2 bucket not bound correctly
# - Invalid image key format
```

#### "Error 401: Unauthorized"

**Cause:** Token validation failed

**Check:**
- Backend and worker use same `IMAGE_TOKEN_SECRET`
- Token not expired (check `exp` claim)
- Token signature valid

#### "Error 403: Forbidden"

**Cause:** Token character_card doesn't match requested image

**Check:**
- Ensure token `character_card` matches image path
- Example: Token for "alex_intellectual" can't access "luna_dancer" images

#### "Images not blurred when locked"

**Causes:**
1. **Free Workers Plan** - Image Resizing requires paid plan ($5/month)
2. **Fallback mode** - Worker sets `X-Blur-Fallback: true` header

**Solutions:**
- Upgrade to Workers Paid plan for transforms
- Or pre-generate blurred versions in R2
- Check for `X-Blur-Fallback: true` header in response

## Security

### Token Validation

The worker validates:
- ✅ JWT signature using HMAC-SHA256
- ✅ Token expiration (`exp` claim)
- ✅ Character card matches requested image
- ✅ Token not reused for different characters

### Token Lifetime

Default: **24 hours** (configurable in backend via `IMAGE_TOKEN_EXPIRATION_HOURS`)

Short-lived tokens prevent:
- Long-term unauthorized access
- Token sharing between users

### Rate Limiting

Cloudflare automatically provides:
- DDoS protection
- Bot detection
- Rate limiting (configurable in dashboard)

## Performance

### Caching Strategy

```typescript
headers.set('Cache-Control', 'public, max-age=31536000'); // 1 year
headers.set('ETag', object.httpEtag);
```

**Why 1 year?**
- Image keys are immutable (include variant number)
- Changing image = new key
- Aggressive caching = faster loads, lower costs

### Cloudflare Image Resizing

**Benefits:**
- On-the-fly transforms (no pre-generation needed)
- Automatic format optimization (WebP, AVIF)
- Smart quality adjustment

**Cost:**
- First 100k requests/month free
- Then $0.50 per 1,000 requests

**Alternative (if cost is concern):**
- Pre-generate resized versions in R2
- Serve directly without transforms

## Cost Estimation

### Workers Paid Plan: $5/month includes:
- 10 million requests/month
- Unlimited scripts
- All features (KV, R2 bindings, Image Resizing)

### R2 Storage:
- **Storage:** $0.015/GB/month
- **Class A operations:** $4.50 per million (write, list)
- **Class B operations:** $0.36 per million (read)

### Example Monthly Cost (1,000 active users):

```
R2 Storage (27 characters × 5 images × 1MB): $2.05/month
R2 Reads (1k users × 10 images/day × 30 days): $0.11/month
Workers Plan: $5.00/month
Image Resizing (300k requests): $1.00/month
────────────────────────────────────────────
Total: ~$8.16/month
```

**Scales well:** At 10k users, cost ~$10-15/month (R2 reads are cheap)

## Development

### Project Structure

```
workers/image-delivery/
├── src/
│   └── index.ts          # Worker entry point (266 lines)
├── package.json          # Dependencies
├── tsconfig.json         # TypeScript config
├── wrangler.toml         # Cloudflare Worker config
└── README.md             # This file
```

### Local Development

```bash
# Start dev server
npm run dev

# Worker runs at http://localhost:8787
# Auto-reloads on code changes
```

### Making Changes

1. Edit `src/index.ts`
2. Test locally with `npm run dev`
3. Deploy to staging: `npm run deploy:staging`
4. Test with real backend
5. Deploy to production: `npm run deploy:production`

## Troubleshooting

### Can't authenticate with Wrangler

```bash
# Logout and login again
wrangler logout
wrangler login

# Use browser auth flow
# Opens browser for OAuth
```

### R2 bucket not accessible

```bash
# Verify bucket exists
wrangler r2 bucket list

# Check wrangler.toml binding matches bucket name
# binding = "IMAGES_BUCKET"
# bucket_name = "character-images"  ← Must match actual bucket
```

### Secret not set or wrong

```bash
# List secrets (shows names only, not values)
wrangler secret list --env staging

# Update secret
wrangler secret put IMAGE_TOKEN_SECRET --env staging

# Delete and recreate if needed
wrangler secret delete IMAGE_TOKEN_SECRET --env staging
wrangler secret put IMAGE_TOKEN_SECRET --env staging
```

### Worker returns 500 errors

```bash
# Check real-time logs
wrangler tail --env staging

# Look for exceptions in logs
# Common issues:
# - Null pointer exceptions
# - Invalid token format
# - R2 object not found
```

## Additional Resources

- [Cloudflare Workers Docs](https://developers.cloudflare.com/workers/)
- [Cloudflare R2 Docs](https://developers.cloudflare.com/r2/)
- [Cloudflare Image Resizing](https://developers.cloudflare.com/images/image-resizing/)
- [Wrangler CLI Reference](https://developers.cloudflare.com/workers/wrangler/)

## Support

For issues or questions:
- Check logs: `wrangler tail --env staging`
- Review Cloudflare dashboard analytics
- Check backend logs for token generation issues
- Verify R2 bucket contains expected images

---

**Last Updated:** 2025-12-01
**Version:** 1.0.0
**Status:** Production Ready ✅
