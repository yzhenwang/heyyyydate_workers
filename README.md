# HeyyyyDate Image Delivery Worker

Cloudflare Worker for secure image delivery with JWT-based access control, automatic blur enforcement for locked images, and image transforms (resize, format conversion).

## Overview

This worker serves character images from Cloudflare R2 storage with the following features:

- **JWT Token Authentication** - Validates image access tokens generated by backend
- **On-the-fly Blur** - Applies blur to locked images using Cloudflare Image Resizing
- **Image Transforms** - Supports resize, format conversion (webp, avif), and quality adjustment
- **Two-layer Caching** - Cloudflare Cache API + R2 transformed bucket for optimal performance
- **Presigned URLs** - Accesses private R2 bucket without public URLs
- **Security** - Prevents token reuse across different characters

## Architecture

```
Frontend                    Backend                     CF Worker                 R2
   │                           │                            │                      │
   │ GET /gallery              │                            │                      │
   │ ───────────────────────►  │                            │                      │
   │                           │                            │                      │
   │ ◄─── images[] + token ─── │  (JWT with unlocked_types) │                      │
   │                           │                            │                      │
   │ GET /img/alex/casual_1.png?token=xxx&w=800             │                      │
   │ ─────────────────────────────────────────────────────► │                      │
   │                           │                            │ verify JWT           │
   │                           │                            │ check unlocked_types │
   │                           │                            │ check cache          │
   │                           │                            │                      │
   │                           │                            │ if cached:           │
   │                           │                            │   return cached      │
   │                           │                            │ else:                │
   │                           │                            │   presigned URL ────►│
   │                           │                            │   apply transforms   │
   │                           │                            │   (blur if locked)   │
   │                           │                            │   cache result       │
   │                           │                            │                      │
   │ ◄───────────────────────────────── image ───────────── │                      │
```

### Single Source + Transform Cache Design

- **`character-images`** - Original high-quality images (source of truth)
- **`character-images-transformed`** - Cached transformed versions (blur, resize, format)

The original bucket remains **private**. The worker:
1. Generates presigned URLs to access originals
2. Applies transforms via Cloudflare Image Resizing
3. Caches results in the transformed bucket

**Benefits:**
- No backend blur generation needed (Pillow removed)
- Single source of truth (no sync issues)
- On-demand transforms (only generate what's needed)
- Flexible caching with stable cache keys

### JWT Token Structure

Tokens are generated by the backend (`ImageTokenService`) and contain:

```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "character_card": "alex_intellectual",
  "unlocked_types": ["profile", "casual"],
  "relationship_level": 4,
  "exp": 1735689600,
  "iat": 1735603200
}
```

### Image Key Format

R2 object keys follow this pattern:
```
{character_card}/{image_type}_{variant}.{extension}

Examples:
  alex_intellectual/profile_1.png
  luna_dancer/casual_2.jpg
  preview/alex_intellectual/profile_1.png  (staging/dev)
```

### URL Format

```
/{character_card}/{image_type}_{variant}.{ext}?token=JWT[&w=WIDTH&h=HEIGHT&q=QUALITY&f=FORMAT]

Parameters:
  - token (required): JWT token from backend
  - w (optional): Width in pixels
  - h (optional): Height in pixels
  - q (optional): Quality (1-100)
  - f (optional): Format (webp, avif, jpeg, png)

Examples:
  /alex_intellectual/profile_1.png?token=eyJhbG...
  /luna_dancer/casual_2.jpg?token=eyJhbG...&w=800&q=85&f=webp
```

### Blur Logic

```typescript
// Extract image type from key (e.g., "casual" from "alex_intellectual/casual_1.png")
const imageType = extractImageType(imageKey);

// Check if this image type is unlocked for this user
const isUnlocked = claims.unlocked_types.includes(imageType);

if (!isUnlocked) {
  // Apply blur=50 via Cloudflare Image Resizing
  cfImageOptions.blur = 50;
}

// Fetch with transforms
const response = await fetch(presignedUrl, {
  cf: { image: cfImageOptions }
});
```

## Prerequisites

### 1. Cloudflare Account

- Sign up at [cloudflare.com](https://cloudflare.com)
- **Workers Paid plan required** for Cloudflare Image Resizing ($5/month)

### 2. Wrangler CLI

```bash
cd workers/image-delivery
npm install

# Verify installation
npx wrangler --version
```

### 3. Authentication

```bash
# Login to Cloudflare
npx wrangler login

# Verify authentication
npx wrangler whoami
```

### 4. R2 Buckets

You need two R2 buckets:

```bash
# List existing buckets
npx wrangler r2 bucket list

# Create buckets if they don't exist
npx wrangler r2 bucket create character-images
npx wrangler r2 bucket create character-images-transformed

# Verify creation
npx wrangler r2 bucket list
```

## Setup

### 1. Install Dependencies

```bash
cd workers/image-delivery
npm install
```

### 2. Configure Secrets

The worker requires these secrets:

```bash
# JWT validation (must match backend IMAGE_TOKEN_SECRET)
npx wrangler secret put IMAGE_TOKEN_SECRET --env staging

# R2 presigned URL generation (same as backend R2 credentials)
npx wrangler secret put R2_ACCESS_KEY_ID --env staging
npx wrangler secret put R2_SECRET_ACCESS_KEY --env staging
npx wrangler secret put R2_ACCOUNT_ID --env staging

# Repeat for production
npx wrangler secret put IMAGE_TOKEN_SECRET --env production
npx wrangler secret put R2_ACCESS_KEY_ID --env production
npx wrangler secret put R2_SECRET_ACCESS_KEY --env production
npx wrangler secret put R2_ACCOUNT_ID --env production
```

### 3. Verify Configuration

Check `wrangler.toml`:

```toml
name = "heyyyydate-image-delivery"
main = "src/index.ts"
compatibility_date = "2024-01-01"

# Original images (source of truth)
[[r2_buckets]]
binding = "IMAGES_BUCKET"
bucket_name = "character-images"

# Cached transformed images
[[r2_buckets]]
binding = "TRANSFORMED_IMAGES"
bucket_name = "character-images-transformed"

[env.staging]
name = "heyyyydate-image-delivery-staging"
# ...

[env.production]
name = "heyyyydate-image-delivery"
# ...
```

## Deployment

### Development / Local Testing

```bash
npm run dev

# Worker runs on http://localhost:8787
# Test health check:
curl http://localhost:8787/health
```

### Deploy to Staging

```bash
npx wrangler deploy --env staging

# Output:
# Published heyyyydate-image-delivery-staging
# https://heyyyydate-image-delivery-staging.<account>.workers.dev
```

**After deployment:**
1. Copy the worker URL
2. Update backend `.env`:
   ```bash
   IMAGE_WORKER_URL=https://heyyyydate-image-delivery-staging.<account>.workers.dev
   ```
3. Restart backend to pick up new config

### Deploy to Production

```bash
npx wrangler deploy --env production

# Output:
# Published heyyyydate-image-delivery
# https://heyyyydate-image-delivery.<account>.workers.dev
```

### Custom Domain (Optional)

For production, you can route the worker to a custom domain:

1. Add domain to Cloudflare
2. Uncomment in `wrangler.toml`:
   ```toml
   routes = [
     { pattern = "images.heyyyydate.com/*", zone_name = "heyyyydate.com" }
   ]
   ```
3. Redeploy: `npx wrangler deploy --env production`
4. Update backend `IMAGE_WORKER_URL=https://images.heyyyydate.com`

## Testing

### 1. Health Check

```bash
curl https://heyyyydate-image-delivery-staging.<account>.workers.dev/health

# Expected response:
{
  "status": "ok",
  "timestamp": "2025-12-02T00:00:00.000Z",
  "images_bucket_configured": true,
  "transformed_bucket_configured": true,
  "presigned_urls_configured": true,
  "images_bucket_accessible": true,
  "images_bucket_count": "1+",
  "transformed_bucket_accessible": true,
  "transformed_bucket_count": "0"
}
```

### 2. Test with Real Token

First, get a token from the backend:

```bash
# Get gallery (returns images with tokens)
curl http://localhost:8000/api/images/characters/{character_id}/gallery \
  -H "Authorization: Bearer {your_jwt_token}"

# Response includes token:
{
  "character_id": "...",
  "images": [...],
  "token_expires_at": "..."
}
```

Then test the worker:

```bash
# Test unlocked image (no blur applied)
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/profile_1.png?token={image_token}" \
  --output test_unlocked.png

# Test locked image (blur applied on-the-fly)
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/intimate_1.png?token={image_token}" \
  --output test_locked.png

# Test with resize
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/profile_1.png?token={image_token}&w=400" \
  --output test_resized.png

# Check headers
curl -I "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/intimate_1.png?token={image_token}"

# Should include:
# X-Image-Blurred: true (if image is locked)
# X-Image-Blurred: false (if image is unlocked)
# X-Cache: HIT (if cached) or MISS (first request)
```

### 3. Test Invalid Token

```bash
# Missing token
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/profile_1.png"
# Expected: 401 Unauthorized: Missing token

# Invalid token
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/alex_intellectual/profile_1.png?token=invalid"
# Expected: 401 Unauthorized: Invalid or expired token

# Token for different character
curl "https://heyyyydate-image-delivery-staging.<account>.workers.dev/other_character/profile_1.png?token={alex_token}"
# Expected: 403 Forbidden: Token not valid for this character
```

## Caching

### Two-Layer Cache Strategy

1. **Cloudflare Cache API (Edge)** - Fast, global, short TTL
2. **R2 Transformed Bucket (Persistent)** - Long-term storage of transformed versions

### Cache Key Structure

Cache keys are **stable** and independent of presigned URL signatures:

```
alex_intellectual_profile_1.png_w800_q85_fwebp     (unlocked, resized)
alex_intellectual_intimate_1.png_blur50_w800      (locked, blurred + resized)
```

This ensures cache hits even when presigned URLs change.

### Cache Headers

```typescript
headers.set('Cache-Control', 'public, max-age=31536000'); // 1 year
headers.set('ETag', object.httpEtag);
headers.set('X-Cache', 'HIT' | 'HIT-R2' | 'MISS' | 'BYPASS');
```

## Monitoring

### View Logs

```bash
# Tail logs for staging
npx wrangler tail --env staging

# Tail logs for production
npx wrangler tail --env production
```

### Check Analytics

Visit [Cloudflare Dashboard](https://dash.cloudflare.com/) -> Workers & Pages -> heyyyydate-image-delivery

Metrics include:
- Requests per second
- Errors
- CPU time
- Request status codes

### Common Issues

#### "Error 1101: Worker threw exception"

**Cause:** Runtime error in worker code

**Debug:**
```bash
npx wrangler tail --env staging

# Common issues:
# - IMAGE_TOKEN_SECRET not set
# - R2_ACCESS_KEY_ID/R2_SECRET_ACCESS_KEY not set
# - R2_ACCOUNT_ID not set
```

#### "Error 401: Unauthorized"

**Cause:** Token validation failed

**Check:**
- Backend and worker use same `IMAGE_TOKEN_SECRET`
- Token not expired (check `exp` claim)
- Token signature valid

#### "Error 403: Forbidden"

**Cause:** Token character_card doesn't match requested image

**Check:**
- Ensure token `character_card` matches image path
- Example: Token for "alex_intellectual" can't access "luna_dancer" images

#### "Error 404: Not Found"

**Cause:** Image doesn't exist in R2

**Check:**
```bash
npx wrangler r2 object list character-images --prefix "alex_intellectual/"
```

#### Transform Failed / Blur Not Applied

**Cause:** Cloudflare Image Resizing not available

**Check:**
- Ensure you have Workers Paid plan ($5/month)
- Image Resizing is included in paid plan
- Check logs for transform errors

## Security

### Token Validation

The worker validates:
- JWT signature using HMAC-SHA256
- Token expiration (`exp` claim)
- Character card matches requested image
- Token not reused for different characters

### Token Lifetime

Default: **24 hours** (configurable in backend via `IMAGE_TOKEN_EXPIRATION_HOURS`)

Short-lived tokens prevent:
- Long-term unauthorized access
- Token sharing between users

### Private Buckets

R2 bucket remains completely private:
- No public access enabled
- Worker generates presigned URLs internally
- Images cannot be accessed without valid token

### Rate Limiting

Cloudflare automatically provides:
- DDoS protection
- Bot detection
- Rate limiting (configurable in dashboard)

## Performance

### Caching Benefits

- **First request:** ~200-500ms (transform + cache)
- **Cached requests:** ~10-50ms (edge cache hit)
- **R2 cache hit:** ~50-100ms (bucket read)

### Auto-Format Detection

The worker automatically detects the best format from the `Accept` header:

```typescript
if (accept.includes('image/avif')) {
  cfImageOptions.format = 'avif';  // Best compression
} else if (accept.includes('image/webp')) {
  cfImageOptions.format = 'webp';  // Good compression, wide support
}
```

## Cost Estimation

### Workers Paid Plan ($5/month):
- 10 million requests/month included
- Cloudflare Image Resizing included
- Additional requests: $0.30 per million

### R2 Storage:
- **Storage:** $0.015/GB/month
- **Class A operations:** $4.50 per million (write, list)
- **Class B operations:** $0.36 per million (read)

### Example Monthly Cost (1,000 active users):

```
Workers Paid Plan: $5.00/month
R2 Storage (27 chars x 5 images x 1MB): $2.00/month
R2 Transformed Cache (estimated 10x): $3.00/month
R2 Reads (1k users x 10 images/day x 30 days): $0.11/month
-----------------------------------------------------------
Total: ~$10/month
```

**Note:** Transform cache reduces repeated Image Resizing costs significantly.

## Development

### Project Structure

```
workers/image-delivery/
├── src/
│   └── index.ts          # Worker entry point
├── package.json          # Dependencies
├── tsconfig.json         # TypeScript config
├── wrangler.toml         # Cloudflare Worker config
└── README.md             # This file
```

### Local Development

```bash
# Start dev server
npm run dev

# Worker runs at http://localhost:8787
# Auto-reloads on code changes
```

**Note:** Local development won't have Image Resizing - transforms will fail gracefully and serve original images.

### Making Changes

1. Edit `src/index.ts`
2. Test locally with `npm run dev`
3. Deploy to staging: `npx wrangler deploy --env staging`
4. Test with real backend
5. Deploy to production: `npx wrangler deploy --env production`

## Troubleshooting

### Can't authenticate with Wrangler

```bash
npx wrangler logout
npx wrangler login
```

### R2 bucket not accessible

```bash
# Verify buckets exist
npx wrangler r2 bucket list

# Check wrangler.toml bindings match bucket names
```

### Secrets not set

```bash
# List secrets (shows names only, not values)
npx wrangler secret list --env staging

# Update secret
npx wrangler secret put IMAGE_TOKEN_SECRET --env staging
npx wrangler secret put R2_ACCESS_KEY_ID --env staging
npx wrangler secret put R2_SECRET_ACCESS_KEY --env staging
npx wrangler secret put R2_ACCOUNT_ID --env staging
```

### Worker returns 500 errors

```bash
# Check real-time logs
npx wrangler tail --env staging

# Common issues:
# - Missing secrets
# - Invalid presigned URL
# - Image Resizing not available (need paid plan)
```

### Clear transformed cache

If you need to regenerate cached transforms:

```bash
# Delete all transformed images (use carefully!)
npx wrangler r2 object list character-images-transformed | xargs -I {} npx wrangler r2 object delete character-images-transformed {}

# Or delete specific prefix
# (No direct wrangler command, use R2 dashboard or API)
```

## Additional Resources

- [Cloudflare Workers Docs](https://developers.cloudflare.com/workers/)
- [Cloudflare R2 Docs](https://developers.cloudflare.com/r2/)
- [Cloudflare Image Resizing](https://developers.cloudflare.com/images/transform-images/)
- [Wrangler CLI Reference](https://developers.cloudflare.com/workers/wrangler/)

## Support

For issues or questions:
- Check logs: `npx wrangler tail --env staging`
- Review Cloudflare dashboard analytics
- Check backend logs for token generation issues
- Verify R2 bucket contains expected images

---

**Last Updated:** 2025-12-01
**Version:** 3.0.0
**Status:** Production Ready (Requires Workers Paid Plan)
